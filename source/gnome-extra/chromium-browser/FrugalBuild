# Compiling Time: 20.50 SBU
# Maintainer: Devil505 <devil505linux@gmail.com>

pkgname=chromium-browser
pkgver=13.0.782.215
pkgrel=3
pkgdesc='An open-source browser project that aims to build a safer, faster, and more stable way for all users to experience the web'
url='http://www.chromium.org/'
depends=('nss' 'alsa-lib' 'hicolor-icon-theme' 'libxslt' 'ffmpeg>=0.8' \
	'libevent>=2.0.10' 'libxscrnsaver' 'libpng>=1.4.1' 'gtk+2' 'libxtst' \
	'libgcrypt' 'dejavu-ttf' 'gnutls' 'libtasn1')
makedepends=('python' 'perl' 'gperf' 'yasm' 'libgl' 'libgnome-keyring' 'cups' 'krb5')
license=('BSD')
groups=('gnome-extra')
archs=('i686' 'x86_64')
_F_gnome_iconcache="y"
Finclude gnome-scriptlet
_F_archive_name="chromium"
up2date="Flasttar http://build.chromium.org/buildbot/official/"
source=(http://build.chromium.org/official/$_F_archive_name-$pkgver.tar.bz2  \
        gcc-4.6.patch \
        glibc-2.14.patch \
        cups_1.5_build_fix.patch \
        make-hash-tools-use-if-instead-of-switch.patch \
        v8-r8472-crbug-77625-huge-number-of-cpu-wakeups.patch \
        chromium-master-prefs-path.patch \
        $pkgname.desktop $pkgname.sh master_preferences)
sha1sums=('00664c5682e7e8e448f447096797ab78e6152ebb' \
          '7572d11b848f719bb4ceb23ed8a444b95ff14bcd' \
          '5df133b63f308a80d31ee1f7384a92e000f3d59d' \
          '5cbbab29fea3e5d1315750bd333268d07e383c6d' \
          'a1c5e60f2c0d47d65459397396a75fad4b98bf55' \
          '3f3a7240473bb7d7e104d1a2b942f54aadd3bc1b' \
          '673f05684986a6ecaa69c00287eafdef6e9e260e' \
          '78ed8913b8a598de6a9e45d206973a846dbe8a51' \
          'e06de4aee77b3deb77e3b08ebb175ec02da42ced' \
          'efc0502b20a1fda64567090ded1b3f6a02d9d090')

build() {
        Fcd
	Fpatchall

	# workaround for gcc 4.5
	# see http://code.google.com/p/chromium/issues/detail?id=41887
	export CFLAGS="${CFLAGS} -fno-ipa-cp"

  build/gyp_chromium -f make build/all.gyp --depth=. \
    -Dno_strict_aliasing=1 \
    -Dwerror= \
    -Dlinux_sandbox_path=/usr/lib/chromium/chromium-sandbox \
    -Dlinux_strip_binary=1 \
    -Drelease_extra_cflags="$CFLAGS" \
    -Dffmpeg_branding=Chrome \
    -Dproprietary_codecs=1 \
    -Duse_system_bzip2=1 \
    -Duse_system_ffmpeg=0 \
    -Duse_system_libevent=1 \
    -Duse_system_libjpeg=1 \
    -Duse_system_libpng=1 \
    -Duse_system_libxml=0 \
    -Duse_system_ssl=0 \
    -Duse_system_yasm=1 \
    -Duse_system_zlib=1 \
    -Duse_gconf=0 \
    -Ddisable_sse2=1 \
    $([[ $CARCH == i686 ]] && echo '-Ddisable_sse2=1')

  make chrome chrome_sandbox BUILDTYPE=Release || Fdie

	Fmkdir usr/lib/chromium
        Fexerel out/Release/chrome usr/lib/chromium/chromium
        Finstallrel 4555 out/Release/chrome_sandbox usr/lib/chromium/chromium-sandbox
	Ffileschown usr/lib/chromium/chromium-sandbox root root
        Finstallrel 644 out/Release/chrome.pak usr/lib/chromium/chrome.pak
        Finstallrel 644 out/Release/resources.pak usr/lib/chromium/resources.pak

        Fln /usr/lib/libavcodec.so.52 /usr/lib/chromium/libavcodec.so.52
        Fln /usr/lib/libavformat.so.52 /usr/lib/chromium/libavformat.so.52
        Fln /usr/lib/libavutil.so.50 /usr/lib/chromium/libavutil.so.50

        cp -a out/Release/locales out/Release/resources  \
	$Fdestdir/usr/lib/chromium/ || Fdie
        find $Fdestdir/usr/lib/chromium/ -name '*.d' -type f -delete
        Finstallrel 644 out/Release/chrome.1 usr/share/man/man1/chromium.1

        Finstall 644 $pkgname.desktop usr/share/applications/$pkgname.desktop
        for size in 16 32 48 256; do
                install -m 0644 -D \
                        chrome/app/theme/chromium/product_logo_${size}.png \
                        $Fdestdir/usr/share/icons/hicolor/${size}x${size}/apps/$pkgname.png
        done

        Fexe $pkgname.sh usr/bin/$pkgname

        Fdocrel LICENSE
	Fbuild_gnome_scriptlet
	
	##custom preferences
	Fmkdir etc/$pkgname
	Finstall 644 master_preferences etc/$pkgname/master_preferences
}
