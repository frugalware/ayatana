# Compiling Time: 1.06 SBU
# Contributor: VMiklos <vmiklos@frugalware.org>
# Maintainer: Krisztian VASAS <iron@frugalware.org>

pkgname=apache
pkgver=2.2.19
pkgrel=2
pkgdesc="A high performance Unix-based HTTP server (with SSL)"
url="http://httpd.apache.org/"
backup=(etc/httpd/conf/{httpd.conf,ssl.conf,ssl.crt/server.crt,ssl.csr/server.csr,ssl.key/server.key} \
	var/www/html/index.html)
depends=('gdbm' 'db>=4.7.25' 'openssl>=1.0.0' 'expat' 'apr-util>=1.3.10')
groups=('network')
archs=('i686' 'x86_64' 'ppc')
up2date="lynx -dump http://httpd.apache.org/download.cgi |grep 'best available'|sed 's/.* \([0-9.]\+\) i.*/\1/;q'"
source=(http://www.apache.org/dist/httpd/httpd-$pkgver.tar.gz \
        http://ftp.frugalware.org/pub/other/sources/apache/mkcert.tar.gz \
	rc.httpd rc.httpd-hu.po httpd.conf ssl.conf \
	README.Frugalware index.html http://frugalware.org/images/frugalware.png)
signatures=($source.asc '' '' '' '' '' '' '' '')

# svn web interface:
# http://svn.apache.org/viewvc/httpd/httpd/branches/2.2.x/
# use it when you dig for secfixes

build()
{
	Fcd httpd-$pkgver
	Fsed '^#define AP_HTTPD_USER.*$' '#define AP_HTTPD_USER "nobody"' \
		support/suexec.h
	Fbuild --sysconfdir=/etc/httpd/conf --enable-layout=RedHat --datadir=/var/www \
		--enable-modules=all --enable-mods-shared=all --enable-ssl \
		--enable-so --with-apr=/usr --with-apr-util=/usr --enable-dbd \
		--enable-proxy --enable-proxy-connect --enable-proxy-ftp \
		--enable-proxy-http --enable-suexec
	Fmv /usr/sbin/suexec /usr/bin/suexec
	Fmkdir /etc/httpd/conf/modules.d/
	cp -a ../mkcert/* $Fdestdir/etc/httpd/conf/
	Frm etc/httpd.conf
	Frm etc/ssl.conf
	Ffile httpd.conf /etc/httpd/conf/httpd.conf
	Ffile ssl.conf /etc/httpd/conf/ssl.conf
	Frcd2 httpd
	Fdoc README.Frugalware
	Frm /var/www/html/index.html
	Ffile /var/www/html/index.html
	Ffile /var/www/html/frugalware.png
	Frm /var/run
	Fmkdir /etc/tmpfiles.d
	cat > $Fdestdir/etc/tmpfiles.d/apache.conf << EOF
d $Flocalstatedir/run 0755 root root -
EOF
}

# optimization OK
